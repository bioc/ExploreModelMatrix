---
title: "ExploreModelMatrix"
author: "Charlotte Soneson"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{ExploreModelMatrix}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
stopifnot(requireNamespace("htmltools"))
htmltools::tagList(rmarkdown::html_dependency_font_awesome())
```

## Introduction

`ExploreModelMatrix` is an R package for visualizing design matrices generated
by the `model.matrix()` R function. Provided with a sample information table and
a design formula, the `ExploreModelMatrix()` function launches a shiny app where
the user can explore the fitted values (in terms of the model coefficients) for
each combination of predictor values. In addition, the app allows the user to
interactively change the design formula and the reference levels of factor
variables as well as drop unwanted columns from the design matrix, in order to
explore the effect on the fitted values.

In addition to the interactive visualization, `ExploreModelMatrix` also provides
a function, `VisualizeDesign()`, for generating static visualizations.

In this vignette, we show examples of applying the `ExploreModelMatrix`
functions to various experimental design setups. Most examples are taken from
questions raised at the Bioconductor support site.

```{r setup}
library(ExploreModelMatrix)
```

## Interface

The `ExploreModelMatrix()` function opens a graphical interface where the user
can interactively explore the provided design. This section provides an overview
of what is shown in the graphical interface. A step-by-step tour is also
available by clicking on the <i class="fa fa-question-circle"></i> icon in
the top right of the application.

<img src=`r system.file(package='ExploreModelMatrix', 'www/ExploreModelMatrix.png')` width="600"/>

The sidebar contains the input controls. The design formula of interest is typed
into the `Design formula` text box, and must start with the `~` symbol. It can
be changed interactively while using the application. If the
`ExploreModelMatrix()` function is called with `sampleData=NULL`, there will
also be an input control allowing a tab-delimited text file with sample
information to be uploaded to the application. The remaining input controls
allow the user to change the reference levels of the factor variables, to drop
specific columns from the design matrix, and to change the display settings of
the plot.

The first row of the main body of the application displays the fitted values (in
terms of the model coefficients) for each combination of predictor values, in
both figure and table form. In the next row, the full provided sample table as
well as a summary are provided, and the bottom row displays the full design
matrix as well as its rank.

## Examples

This section contains a number of examples of real designs, and how they can be
explored with `ExploreModelMatrix`. For each example, the sample information
table is printed out. Next, the `VisualizeDesign()` function is called to
generate a static plot of the fitted values, in terms of the model coefficients.
This is the same plot that is displayed in the top left panel of the interactive
interface generated by `ExploreModelMatrix()`. We also provide the code for
generating and (for interactive sessions) opening the interactive application
with `ExploreModelMatrix()`.

### Example 1

```{r, fig.width = 7}
(sampleData <- data.frame(genotype = rep(c("A", "B"), each = 4),
                          treatment = rep(c("ctrl", "trt"), 4)))
vd <- VisualizeDesign(sampleData = sampleData, 
                      designFormula = ~ genotype + treatment, 
                      textSizeFitted = 4)
cowplot::plot_grid(plotlist = vd$plotlist)
app <- ExploreModelMatrix(sampleData = sampleData,
                          designFormula = ~ genotype + treatment)
if (interactive()) shiny::runApp(app)
```

### Example 2

```{r, fig.height = 5}
set.seed(1)
(sampleData <- data.frame(
  age = round(runif(10, min = 12, max = 60))
))
vd <- VisualizeDesign(sampleData = sampleData,
                      designFormula = ~ age, textSizeFitted = 3)
cowplot::plot_grid(plotlist = vd$plotlist, ncol = 1)
app <- ExploreModelMatrix(sampleData = sampleData,
                          designFormula = ~ age)
if (interactive()) shiny::runApp(app)
```

### Example 3

From https://support.bioconductor.org/p/122506/,
https://support.bioconductor.org/p/122613/

```{r, fig.height = 5, fig.width = 5}
(sampleData <- data.frame(
  group = factor(rep(1:4, each = 6)),
  subject = rep(1:8, each = 3),
  treatment = factor(rep(c("a", "b", "a", "b"), each = 6)),
  time = factor(c(rep(1:3, 4), rep(c(1, 4, 5), 4)))))
vd <- VisualizeDesign(sampleData = sampleData,
                      designFormula = ~ 0 + treatment + time:treatment, 
                      flipCoordFitted = TRUE, textSizeFitted = 4)
cowplot::plot_grid(plotlist = vd$plotlist)
app <- ExploreModelMatrix(sampleData = sampleData,
                          designFormula = ~ 0 + treatment + time:treatment)
if (interactive()) shiny::runApp(app)
vd <- VisualizeDesign(sampleData = sampleData,
                      designFormula = ~ treatment * time, 
                      flipCoordFitted = TRUE, textSizeFitted = 4)
cowplot::plot_grid(plotlist = vd$plotlist)
```

### Example 4

From https://support.bioconductor.org/p/112947/

```{r, fig.width = 7}
(sampleData = data.frame(
  group = factor(rep(c("NR", "NT", "P", "F"), c(11, 26, 14, 4))),
  batch = factor(c(3, 3, 3, 4, 4, 6, 3, 3, 3, 6, 6, 6, 6, 6, 4, 6, 3, 3, 
                   3, 3, 3, 4, 4, 4, 4, 6, 6, 6 ,6, 3, 3, 6, 6, 6, 6, 6, 
                   6, 3, 3, 3, 3, 4, 4, 4, 6, 3, 3, 3, 3, 6, 6, 3, 3, 3, 3))))
vd <- VisualizeDesign(sampleData = sampleData,
                      designFormula = ~ 0 + batch + group, 
                      textSizeFitted = 4, addColorFitted = FALSE)
cowplot::plot_grid(plotlist = vd$plotlist)
app <- ExploreModelMatrix(sampleData = sampleData,
                          designFormula = ~ 0 + batch + group)
if (interactive()) shiny::runApp(app)
vd <- VisualizeDesign(sampleData = sampleData,
                      designFormula = ~ 0 + group + batch, 
                      textSizeFitted = 4, colorPalette = scales::viridis_pal())
cowplot::plot_grid(plotlist = vd$plotlist)
```

### Example 5

From https://support.bioconductor.org/p/120850/

```{r, fig.width = 7, fig.height = 16}
(sampleData <- data.frame(
  Response = rep(c("Resistant", "Sensitive"), c(12, 18)),
  Patient = factor(rep(c(1:6, 8, 11:18), each = 2)),
  Treatment = factor(rep(c("pre","post"), 15)), 
  ind.n = factor(rep(c(1:6, 2, 5:12), each = 2))))
vd <- VisualizeDesign(sampleData = sampleData,
                      designFormula = ~ Response + Response:ind.n + Response:Treatment,
                      textSizeFitted = 3)
cowplot::plot_grid(plotlist = vd$plotlist, ncol = 1)
app <- ExploreModelMatrix(sampleData = sampleData,
                          designFormula = ~ Response + Response:ind.n + Response:Treatment)
if (interactive()) shiny::runApp(app)
```

```{r, fig.width = 7}
vd <- VisualizeDesign(sampleData = sampleData,
                      designFormula = ~ Treatment + Response, 
                      textSizeFitted = 4)
cowplot::plot_grid(plotlist = vd$plotlist, ncol = 1)
```

### Example 6

From https://support.bioconductor.org/p/120591/

```{r, fig.width = 7}
(sampleData <- data.frame(
  samples = c("Cell1_HA1", "Cell1_HA2", "Cell1_foxcut11", 
              "Cell1_foxcut12", "Cell2_HA1", "Cell2_HA2", 
              "Cell2_foxcut11", "Cell2_foxcut12"), 
  type = c("Control", "Control", "FOXCUT", "FOXCUT", 
           "Control", "Control", "FOXCUT", "FOXCUT"), 
  replicate = factor(c(1, 2, 1, 2, 3, 4, 3, 4)), 
  celline = factor(c(1, 1, 1, 1, 2, 2, 2, 2))))
sampleData$group <- paste0(sampleData$type, ".", sampleData$celline)
vd <- VisualizeDesign(sampleData = sampleData,
                      designFormula = ~ 0 + group + replicate, 
                      textSizeFitted = 3)
cowplot::plot_grid(plotlist = vd$plotlist, ncol = 1)
app <- ExploreModelMatrix(sampleData = sampleData,
                          designFormula = ~ 0 + group + replicate)
if (interactive()) shiny::runApp(app)
```

### Example 7

From https://support.bioconductor.org/p/122641/

```{r, fig.height = 9, fig.width = 7}
(sampleData <- data.frame(individual = factor(rep(1:3, each = 4)), 
                          time = rep(rep(c("before", "after"), each = 2), 3), 
                          exerc = rep(c("trained", "untrained"), 6)))
vd <- VisualizeDesign(sampleData = sampleData, 
                      designFormula = ~ individual + time*exerc, 
                      textSizeFitted = 4)
cowplot::plot_grid(plotlist = vd$plotlist, ncol = 1)
app <- ExploreModelMatrix(sampleData = sampleData,
                          designFormula = ~ individual + time*exerc)
if (interactive()) shiny::runApp(app)
```

```{r, fig.height = 4, fig.width = 7}
sampleData$group <- paste(sampleData$exerc, sampleData$time, sep = ".")
vd <- VisualizeDesign(sampleData = sampleData,
                      designFormula = ~ 0 + individual + group, 
                      textSizeFitted = 3)
cowplot::plot_grid(plotlist = vd$plotlist, ncol = 1)
```

### Example 8

From https://support.bioconductor.org/p/80408/

```{r, fig.height = 5, fig.width = 7}
(sampleData = data.frame(
  condition = factor(rep(c("ctrl_minus", "ctrl_plus", "ko_minus", "ko_plus"), 3)),
  batch = factor(rep(1:6, each = 2))))
vd <- VisualizeDesign(sampleData = sampleData,
                      designFormula = ~ 0 + batch + condition, 
                      textSizeFitted = 4, lineWidthFitted = 20, 
                      dropCols = "conditionko_minus")
cowplot::plot_grid(plotlist = vd$plotlist, ncol = 1)
app <- ExploreModelMatrix(sampleData = sampleData,
                          designFormula = ~ batch + condition)
if (interactive()) shiny::runApp(app)
```

### Example 9

From https://support.bioconductor.org/p/64480/

```{r, fig.width = 7, fig.height = 7}
(sampleData <- data.frame(
  status = factor(rep(c(0, 1), c(8, 6))),
  rep = factor(c(1, 1, 2, 2, 3, 3, 4, 4, 1, 1, 2, 2, 3, 3)),
  time = factor(rep(c(0, 1), 7))
))
vd <- VisualizeDesign(sampleData = sampleData,
                      designFormula = ~ status + time + status:rep + status:time,
                      textSizeFitted = 4, 
                      dropCols = "status1:rep4")
cowplot::plot_grid(plotlist = vd$plotlist, ncol = 1)
app <- ExploreModelMatrix(sampleData = sampleData, 
                          designFormula = ~ status + time + status:rep + status:time)
if (interactive()) shiny::runApp(app)
```

### Example 10

From https://support.bioconductor.org/p/122764/

```{r, fig.height = 7, fig.width = 7}
(sampleData <- data.frame(
  disease = rep(c("healthy", "disease"), c(6, 9)),
  treatment = rep(c("None", "Drug_A", "Drug_B"), 5),
  patient = factor(rep(c(1:2, 1:3), each = 3))
))
vd <- VisualizeDesign(sampleData = sampleData,
                      designFormula = ~ disease + disease:patient + disease:treatment,
                      textSizeFitted = 3, 
                      dropCols = "diseasehealthy:patient3")
cowplot::plot_grid(plotlist = vd$plotlist, ncol = 1)
app <- ExploreModelMatrix(sampleData = sampleData, 
                          designFormula = ~ disease + disease:patient + disease:treatment)
if (interactive()) shiny::runApp(app)

## Alternative formulation
sampleData$patient <- factor(rep(1:5, each = 3))
sampleData
vd <- VisualizeDesign(sampleData = sampleData,
                      designFormula = ~ 0 + patient + disease:treatment,
                      textSizeFitted = 3, 
                      dropCols = c("diseasedisease:treatmentNone",
                                   "diseasehealthy:treatmentNone"))
app <- ExploreModelMatrix(sampleData = sampleData, 
                          designFormula = ~ 0 + patient + disease:treatment)
if (interactive()) shiny::runApp(app)
```

## Session info

```{r}
sessionInfo()
```

